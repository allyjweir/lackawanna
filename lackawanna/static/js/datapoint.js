// Generated by CoffeeScript 1.8.0
var markCurrentCollections, populateCollections, updateDatapoint;

$(document).ready(function() {
  $('#dataoint-tabs a:first').tab('show');
  $.fn.editable.defaults.mode = 'inline';
  $(".editable-details").editable({
    url: function(params) {
      var datapoint_pk, updated_data;
      console.log("Time to save x-editable new stuff: " + params.update);
      updated_data = {};
      updated_data[params.name] = params.value;
      datapoint_pk = $("#pk").text();
      return updateDatapoint(datapoint_pk, updated_data);
    }
  });
  return console.log("Page loaded");
});

$('#collections-button').click(function() {
  console.log("Collection Button clicked!");
  $("div > #loading-spinner").show();
  $("#collections-list").empty();
  $("#collections-save-button").button("reset");
  return populateCollections();
});

$("#collections-save-button").click(function() {
  var collection, datapoint_pk, selected, updated_data, _i, _len, _ref;
  $("#collections-save-button").button("loading");
  console.log("Save button Clicked");
  selected = [];
  _ref = $("#collections-list input:checkbox:checked");
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    collection = _ref[_i];
    selected.push($(collection).prop('value'));
  }
  datapoint_pk = $("#pk").text();
  updated_data = {
    "collections": selected
  };
  updateDatapoint(datapoint_pk, updated_data);
  $("#collections-save-button").button("reset");
  return $("#collection-Modal").hide();
});

populateCollections = function() {
  return $.ajax("http://localhost:8080/apiv1/collections", {
    type: "GET",
    dataType: "json",
    data: {
      project: $("#project-pk").text()
    },
    error: function(jqXHR, textStatus, errorThrown) {
      return console.log("Couldn't retrieve the datapoint's project's collections (mouthful): " + textStatus);
    },
    success: function(data, textStatus, jqXHR) {
      var collection, _i, _len;
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        collection = data[_i];
        $("#collections-list").append("<input type='checkbox' class='collection-checkbox' id='checkbox-" + collection.pk + "' value='" + collection.pk + "' /> " + collection.name + "<br />");
      }
      return markCurrentCollections();
    }
  });
};

updateDatapoint = function(datapoint_pk, updated_data) {
  return $.ajax("http://localhost:8080/apiv1/datapoints/" + datapoint_pk, {
    headers: {
      'X-CSRFToken': $.cookie('csrftoken')
    },
    type: "patch",
    dataType: "json",
    traditional: true,
    data: updated_data,
    error: function(jqXHR, textStatus, errorThrown) {
      return console.log("failed to save updated datapoint: " + textStatus);
    },
    success: function(data, textStatus, jqXHR) {
      return console.log("successfully updated datapoint");
    }
  });
};

markCurrentCollections = function() {
  return $.ajax("http://localhost:8080/apiv1/datapoints/" + ($("#pk").text()), {
    type: "GET",
    dataType: "json",
    error: function(jqXHR, textStatus, errorThrown) {
      console.log("Couldn't retrieve datapoint's info: " + textStatus);
      return null;
    },
    success: function(data, textStatus, jqXHR) {
      var collection, _i, _len, _ref;
      console.log("into success of dp: " + data.collections);
      _ref = data.collections;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        collection = _ref[_i];
        $("#collections-list > #checkbox-" + collection).prop('checked', 'true');
      }
      $("div #loading-spinner").hide();
      return $("div #collections-table").show();
    }
  });
};
